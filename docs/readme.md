# Madoi 利用マニュアル

## 目次
* 簡単な使い方(TBD)
  * ルームへの参加とメッセージ配信(TBD)
  * 関数実行共有(JavaScript)(TBD)
  * オブジェクト共有(JavaScript)(TBD)
* 機能
  * ルーム管理
  * ピア管理
  * 共有オブジェクト管理
  * メッセージ配信


## 機能

### ルーム管理

- ルームID(文字列)でルームを区別する
  - ピアリストやメッセージ配信はルーム毎に独立して管理する。ルームが違うピアの情報を取得できず、メッセージも他のルームのものが混じることはない。
- ルームのプロファイル情報(名前: 値のペアのリスト)を管理する
  - ピアがプロファイルを設定・削除できる。変更があれば全てのピアに通知される。
  - ピアがルームに参加する際にピアに通知される。
  - 関連メッセージ
    - EnterRoomAllowed
    - RoomProfileUpdated

### ピア管理

- ピアID(文字列)でピアを区別する
- ピアのプロファイル情報(名前: 値のペアのリスト)を管理する
  - ピア自身がプロファイルを設定・削除できる。変更があれば他のピアに通知される。
  - 関連メッセージ
    - PeerProfileUpdated
- ピアの参加・離脱を管理する
  - ピアの参加時に、参加してきたピアに対して、ルームのプロファイルや他のピアの情報を通知する。既存のピアには、参加してきたピアの情報を通知する。
  - ピアのルームからの離脱時に、他のピアに離脱したことを通知する。
  - 関連メッセージ
    - EnterRoomAllowed
    - EnterRoomDenied
    - LeaveRoom
    - LeaveRoomDone
    - PeerEntered
    - PeerLeaved

### 共有関数管理

- 共有関数の定義を管理する
  - ルーム参加後に、使用する関数のID(連番)と定義を送信する。サーバ側では定義を保存する。
  - 関連メッセージ
    - DefineFunction
- 関数実行
  - ピアが共有関数のIDとパラメータを送信すると、他のピアにも通知される
    - 実行前送信(beforeExec, デフォルト)
      - 実行前に送信し、broadcast(定義は後述)する。送信したメッセージを受け取ると、実行する。
    - 実行後送信(afterExec)
      - 関数を実行してからothercast(定義は後述)する。他のピアがメッセージを受け取ると、実行する。
  - 関連メッセージ
    - InvokeFunction

### 共有オブジェクト管理

- 共有オブジェクトの定義を管理する
  - ルーム参加後に、使用するオブジェクトのID(連番)と定義を送信する。サーバ側では定義を保存する。
  - 関連メッセージ
    - DefineObject
- メソッド実行
  - ピアが共有関数のIDとパラメータを送信すると、他のピアにも通知される
    - 実行前送信(beforeExec, デフォルト)
      - 実行前に送信し、broadcast(定義は後述)する。送信したメッセージを受け取ると、実行する。
    - 実行後送信(afterExec)
      - 関数を実行してからothercast(定義は後述)する。他のピアがメッセージを受け取ると、実行する。
  - 関連メッセージ
    - InvokeMethod
- 状態履歴管理
  - ホストピア(最もIDが辞書順で小さいピア)が、オブジェクトの状態をサーバに送信する。
  - サーバが受け取ると、以前の状態と不要になったメソッド実行履歴を削除する。
    - UpdateObjectState

### メッセージ配信

- メッセージ配信は、サーバと各ピアで行う
- 送信方法
  - unicast
    - 特定のサーバ又はピアへの送信
  - multicast
    - 複数のサーバ又はピアへの送信
  - boradcast
    - 全てのサーバ又はピアへの送信
  - othercast
    - 自分以外のサーバ又はピアへの送信
  - selfcast
    - 自分のみへの送信。ピアが送信した場合、一旦サーバに送信されてから自身に送信される。
  - peerToServer
    - ピアからサーバへの送信。送信先が設定されているかどうかに関わらずサーバが受け取る
  - serverToPeer
    - サーバから特定のピアへの送信。
- メッセージの基本構造
  - type
    - メッセージタイプ
  - sender
    - 送信者。ピアが送信する場合、自身で設定したかどうかに関わらず、サーバ側で設定される。
  - castType
    - 送信方法(上記)
  - recipients
    - 宛先。サーバ(__SYSTEM__)又はピアID。
  - 任意の項目
    - 上記4つ以外の名前を持つ、任意の型の情報。
- 予約メッセージ
  - ルーム管理
    - EnterRoom
    - EnterRoomAllowed
    - LeaveRoom
    - LeaveRoomDone
    - RoomProfileUpdated
  - ピア管理
    - PeerEntered
    - PeerLeaved
    - PeerProfileUpdated
  - 共有関数管理
    - DefineFunction
    - InvokeFunction
  - 共有オブジェクト管理
    - DefineObject
    - UpdateObjectState
    - InvokeMethod
  - 任意メッセージ
    - 予約メッセージ以外のメッセージタイプを持つメッセージ
